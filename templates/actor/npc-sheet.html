<form class="{{cssClass}} flexcol mcde-npc-sheet" autocomplete="off">

  <style>
  .mcde-avatar {
    flex: 0 0 140px;            /* largeur réservée au bloc avatar */
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }

  .mcde-avatar .profile-img {
    width: 140px;
    height: 140px;
    object-fit: cover;          /* remplis proprement */
  }

  .sheet-header .header-fields {
    flex: 1 1 auto;             /* le reste prend l’espace */
    min-width: 0;
  }


    /* ============================
   NPC sheet: item hover controls
   ============================ */

/* 1) Chaque ligne/item doit être un conteneur positionné */
.mcde.sheet.actor.npc .mcde-weapon,
.mcde.sheet.actor.npc .mcde-talent,
.mcde.sheet.actor.npc .mcde-ts-item {
  position: relative;
}

/* 2) Zone controls à droite, hors flux */
.mcde.sheet.actor.npc .item-controls {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 6px;
  align-items: center;

  /* caché tant qu'on ne hover pas */
  opacity: 0;
  pointer-events: none;
}

/* 3) Montrer au hover de la "ligne" */
.mcde.sheet.actor.npc .mcde-weapon:hover .item-controls,
.mcde.sheet.actor.npc .mcde-talent:hover .item-controls,
.mcde.sheet.actor.npc .mcde-ts-item:hover .item-controls {
  opacity: 1;
  pointer-events: auto;
}

/* évite que le texte passe sous les icônes */
.mcde.sheet.actor.npc .mcde-weapon .item-name,
.mcde.sheet.actor.npc .mcde-weapon .item-detail,
.mcde.sheet.actor.npc .mcde-talent details > summary {
  padding-right: 64px;
}

  </style>

<!-- ================= HEADER ================= -->
<header class="sheet-header flexrow" style="align-items:flex-start; gap:12px;">

  <div class="mcde-avatar-wrap" style="flex:0 0 140px;">
    <div class="mcde-avatar-frame">
      <img class="profile-img mcde-avatar"
           src="{{actor.img}}"
           data-edit="img"
           title="{{actor.name}}"/>
    </div>
  </div>

  <div class="header-fields flexcol" style="flex:1; min-width:0; margin-left:0;">
    <h1>
      <input name="name" type="text" value="{{actor.name}}" placeholder="NPC Name"/>
    </h1>

<!-- NPC Type -->
<div class="npc-type">
  <div class="npc-type-row">
    <div class="npc-type-left">
      <div class="npc-type-label">TYPE</div>
      <div class="npc-type-select">
        <select name="system.npcType">
          <option value="trooper" {{#if (eq system.npcType "trooper")}}selected{{/if}}>Troopers</option>
          <option value="elite" {{#if (eq system.npcType "elite")}}selected{{/if}}>Elites</option>
          <option value="horde_squad" {{#if (eq system.npcType "horde_squad")}}selected{{/if}}>Hordes &amp; Squads</option>
        </select>
      </div>
    </div>

    <div class="npc-type-iconwrap">
      {{#if (eq system.npcType "trooper")}}
        <img class="npc-type-icon" src="systems/mutant-chronicles-diesel-edition/assets/npctypes/trooperslogo.png">
      {{/if}}
      {{#if (eq system.npcType "elite")}}
        <img class="npc-type-icon" src="systems/mutant-chronicles-diesel-edition/assets/npctypes/eliteslogo.png">
      {{/if}}
      {{#if (eq system.npcType "horde_squad")}}
        <img class="npc-type-icon" src="systems/mutant-chronicles-diesel-edition/assets/npctypes/hordessquadslogo.png">
      {{/if}}
    </div>
  </div>
</div>

    <!-- Soak -->
    <div class="soak" style="margin-bottom:6px; display:flex; gap:8px; align-items:center;">
      <label>Soak</label>

      <input type="number"
             name="system.soak.value"
             value="{{system.soak.value}}"
             min="0"
             step="1"
             style="width:60px;"/>

      <input type="text"
             name="system.soak.type"
             value="{{system.soak.type}}"
             placeholder="Nature (e.g. Incorporeal)"
             style="flex:1;"/>
    </div>

    <!-- Wounds -->
<div class="wounds flexcol mcde-npc-wounds">

  <div class="wounds-row flexrow">
    <label>Wounds</label>

    <input
      type="number"
      name="system.wounds.total"
      value="{{system.wounds.total}}"
      min="0"
      class="wounds-total"
    />

    <small class="wounds-suffered">
      Suffered: {{system.wounds.current}}
    </small>
  </div>

  <div class="wound-track flexrow">
    {{#each woundBoxes as |box|}}
      <div
        class="wound-box {{#if box.filled}}filled{{/if}}"
        data-index="{{box.index}}">
      </div>
    {{/each}}
  </div>

</div>

</div><!-- /.header-fields -->
</header>

  <!-- ================= TABS ================= -->
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="stats">Stats</a>
    <a class="item" data-tab="description">Description</a>
  </nav>

  <!-- ================= BODY ================= -->
  <section class="sheet-body">

    <!-- ================= STATS TAB ================= -->
    <div class="tab" data-group="primary" data-tab="stats">

      <!-- ===== TWO-COLUMN GRID (50/50) ===== -->
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:start;">

        <!-- LEFT COLUMN: Attributes -> Weapons -> Special Abilities -->
        <div style="min-width:0;">

<!-- ATTRIBUTES -->
<h3 style="margin:0;">Attributes</h3>
<table style="width:100%; margin-top:4px;">
  <tbody>
    <tr>
      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="strength">STRENGTH</a></small><br>
        <div class="mcde-attrline" data-attr="strength">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.strength.value"
                 value="{{system.attributes.strength.value}}">

          {{#if (gt system.attributes.strength.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.strength.auto"
                   value="{{system.attributes.strength.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="physique">PHYSIQUE</a></small><br>
        <div class="mcde-attrline" data-attr="physique">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.physique.value"
                 value="{{system.attributes.physique.value}}">

          {{#if (gt system.attributes.physique.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.physique.auto"
                   value="{{system.attributes.physique.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="agility">AGILITY</a></small><br>
        <div class="mcde-attrline" data-attr="agility">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.agility.value"
                 value="{{system.attributes.agility.value}}">

          {{#if (gt system.attributes.agility.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.agility.auto"
                   value="{{system.attributes.agility.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="awareness">AWARENESS</a></small><br>
        <div class="mcde-attrline" data-attr="awareness">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.awareness.value"
                 value="{{system.attributes.awareness.value}}">

          {{#if (gt system.attributes.awareness.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.awareness.auto"
                   value="{{system.attributes.awareness.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>
    </tr>

    <tr>
      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="coordination">COORDINATION</a></small><br>
        <div class="mcde-attrline" data-attr="coordination">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.coordination.value"
                 value="{{system.attributes.coordination.value}}">

          {{#if (gt system.attributes.coordination.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.coordination.auto"
                   value="{{system.attributes.coordination.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="intelligence">INTELLIGENCE</a></small><br>
        <div class="mcde-attrline" data-attr="intelligence">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.intelligence.value"
                 value="{{system.attributes.intelligence.value}}">

          {{#if (gt system.attributes.intelligence.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.intelligence.auto"
                   value="{{system.attributes.intelligence.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="mental_strength">MENTAL STRENGTH</a></small><br>
        <div class="mcde-attrline" data-attr="mental_strength">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.mental_strength.value"
                 value="{{system.attributes.mental_strength.value}}">

          {{#if (gt system.attributes.mental_strength.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.mental_strength.auto"
                   value="{{system.attributes.mental_strength.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>

      <td>
        <small><a class="mcde-roll" data-roll="attribute" data-attribute="personality">PERSONALITY</a></small><br>
        <div class="mcde-attrline" data-attr="personality">
          <input class="mcde-attr-val" type="number"
                 name="system.attributes.personality.value"
                 value="{{system.attributes.personality.value}}">

          {{#if (gt system.attributes.personality.auto 0)}}
            <span class="mcde-paren">(</span>
            <input class="mcde-attr-auto" type="number" min="0"
                   name="system.attributes.personality.auto"
                   value="{{system.attributes.personality.auto}}">
            <span class="mcde-paren">)</span>
          {{else}}
            <a class="mcde-attr-auto-add" title="Add supernatural auto-success"><span class="mcde-paren">(</span>+<span class="mcde-paren">)</span></a>
          {{/if}}
        </div>
      </td>
    </tr>
  </tbody>
</table>



          <!-- WEAPONS -->
          <h3 style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
            <span>Weapons</span>
            <a class="mcde-weapon-add" title="Add weapon" style="flex:0 0 auto;">+</a>
          </h3>

<ul class="items-list mcde-items mcde-hover-controls" style="list-style:none; padding-left:0; margin:0;">
  {{#each actor.items as |item|}}
    {{#if (eq item.type "weapon")}}
      <li class="item mcde-weapon" data-item-id="{{item._id}}" draggable="true" style="margin-bottom:6px;">
        <div class="item-name" style="display:flex; align-items:center; gap:8px;">
          <h4 style="margin:0;">
            <strong>
              <a class="mcde-roll" data-roll="weapon" data-item-id="{{item._id}}">{{item.name}}</a>
              <span style="opacity:0.75; font-weight:normal;">
                (
                {{#if (or (eq item.system.weaponType "melee") (eq item.system.weaponType "unarmed"))}}
                  Melee
                {{else}}
                  Ranged
                {{/if}}
                )
              </span>
            </strong>
          </h4>
        </div>

        <div class="item-detail" style="opacity:0.9;">
          {{#if (or (eq item.system.weaponType "ranged") (eq item.system.weaponType "heavy") (eq item.system.weaponType "mounted"))}}
            Range: <strong>{{item.system.stats.range}}</strong> |
            Mode: <strong>{{item.system.stats.mode}}</strong> |
          {{/if}}
          Damage: <strong>{{item.system.damage.base}}</strong> + <strong>{{{dsValue item.system.damage.dsy}}}</strong>
        </div>

        {{#if item.system.qualities.length}}
          <div class="item-detail" style="display:flex; flex-wrap:wrap; gap:4px;">
            {{#each item.system.qualities as |q|}}
              <span class="mcde-tag" data-tooltip="{{q.description}}"
                    style="padding:2px 6px; border:1px solid rgba(120,0,0,0.4); border-radius:10px; font-size:11px;">
                {{q.name}}
              </span>
            {{/each}}
          </div>
        {{/if}}

        <div class="item-controls">
          <a class="item-control mcde-weapon-edit" title="Edit"><i class="fas fa-edit"></i></a>
          <a class="item-control mcde-weapon-delete" title="Delete"><i class="fas fa-trash"></i></a>
        </div>
      </li>
    {{/if}}
  {{/each}}
</ul>

          <!-- SPECIAL ABILITIES -->
          <h3 style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
            <span>Special Abilities</span>
            <a class="mcde-talent-add" title="Add talent" style="flex:0 0 auto;">+</a>
          </h3>

<div class="mcde-talent-dropzone" style="border:none; padding:0; margin:0;">

  <ul class="items-list mcde-talents" style="list-style:none; padding-left:0; margin:0;">
    {{#each actor.items as |item|}}
      {{#if (eq item.type "talent")}}
        <li class="item mcde-talent" data-item-id="{{item._id}}" draggable="true" style="margin-bottom:6px;">
          <details>
<summary class="mcde-acc-summary" style="display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer;">
  <span class="mcde-acc-title">
    <span class="mcde-acc-caret" aria-hidden="true">▶</span>
    <strong>{{item.name}}</strong>
  </span>

  <span class="item-controls" style="gap:6px;">
    <a class="item-control mcde-talent-edit" title="Edit"><i class="fas fa-edit"></i></a>
    <a class="item-control mcde-talent-delete" title="Delete"><i class="fas fa-trash"></i></a>
  </span>
</summary>
            <div style="margin-top:6px;">{{{dsify item.system.description}}}</div>
          </details>
        </li>
      {{/if}}
    {{/each}}
  </ul>
</div>

</div>

        <!-- RIGHT COLUMN: Fields of Expertise -> Dark Symmetry Spends -->
        <div style="min-width:0;">

          <!-- FIELDS OF EXPERTISE -->
          <h3 style="margin:0;">Fields of Expertise</h3>
          <table style="width:100%; margin-top:4px;">
            <thead>
              <tr>
                <th style="text-align:left;"></th>
                <th style="width:60px;">EXP</th>
                <th style="width:60px;">FOC</th>
              </tr>
            </thead>
            <tbody>
              {{#each expertiseList as |s|}}
                <tr>
                  <td><small><a class="mcde-roll" data-roll="npc-skill" data-skill="{{s.key}}">{{s.label}}</a></small></td>
                  <td><input type="number" name="system.skills.{{s.key}}.expertise" value="{{s.exp}}" style="width:55px"></td>
                  <td><input type="number" name="system.skills.{{s.key}}.focus" value="{{s.foc}}" style="width:55px"></td>
                </tr>
              {{/each}}
            </tbody>
          </table>

          <!-- DARK SYMMETRY SPENDS -->
          <h3 style="margin-top:12px;">Dark Symmetry Spends</h3>
          {{editor enriched.darkSymmetrySpendsText target="system.darkSymmetrySpendsText" button=true owner=owner editable=editable engine="prosemirror"}}

        </div>

      </div> <!-- /grid -->

    </div>

<!-- ================= DESCRIPTION TAB ================= -->
<div class="tab" data-group="primary" data-tab="description">
  {{editor enriched.notes target="system.notes" button=true owner=owner editable=editable engine="prosemirror"}}
</div>


  </section>
</form>
